---

default:
  before_script:
    - |
      sudo apt-get update
      sudo apt-get -y install bridge-utils dnsmasq-base ebtables libguestfs-tools libvirt-clients libvirt-daemon-system libvirt-dev qemu-kvm qemu-utils ruby-dev

    - |
      curl -Os https://releases.hashicorp.com/vagrant/2.2.14/vagrant_2.2.14_x86_64.deb
      curl -Os https://releases.hashicorp.com/vagrant/2.2.14/vagrant_2.2.14_SHA256SUMS
      curl -Os https://releases.hashicorp.com/vagrant/2.2.14/vagrant_2.2.14_SHA256SUMS.sig
      curl -skL https://keybase.io/hashicorp/pgp_keys.asc | sudo gpg --import
      gpg --verify vagrant_2.2.14_SHA256SUMS.sig vagrant_2.2.14_SHA256SUMS
      sha256sum -c vagrant_2.2.14_SHA256SUMS 2>&1 | grep OK
      sudo dpkg -i vagrant_2.2.14_x86_64.deb
      sudo vagrant plugin install vagrant-libvirt
      rm -rf vagrant_2.2.14_*

    - |
      sudo apt-get update
      sudo apt-get -y purge python3-openssl
      sudo apt-get -y install ca-certificates curl gcc iproute2 pwgen python3 python3-dev sudo
      curl -skL https://bootstrap.pypa.io/get-pip.py | sudo -H python3 - --prefix=/usr/local
      sudo -H pip3 install --prefix=/usr/local --upgrade --ignore-installed --requirement requirements.txt

    - |
      export ROLE=$(echo $CI_PROJECT_NAME | sed 's/^.*\/ansible-role-/\//g')
      mkdir -p $HOME/.ansible/roles
      mkdir -p $HOME/.ansible/collections/alvistack
      ln -s $CI_PROJECT_DIR $HOME/.ansible/roles/$ROLE

  script:
    - |
      source ./scripts/run-tests.sh \
        && sudo -E molecule dependency -s $MOLECULE_SCENARIO_NAME \
        && sudo -E molecule lint -s $MOLECULE_SCENARIO_NAME \
        && sudo -E molecule syntax -s $MOLECULE_SCENARIO_NAME \
        && sudo -E molecule converge -s $MOLECULE_SCENARIO_NAME \
        && sudo -E molecule idempotence -s $MOLECULE_SCENARIO_NAME \
        && sudo -E molecule side-effect -s $MOLECULE_SCENARIO_NAME \
        && sudo -E molecule verify -s $MOLECULE_SCENARIO_NAME

job:
  "ubuntu-20.04":
    variables:
      MOLECULE_SCENARIO_NAME: "ubuntu-20.04"

  "ubuntu-18.04":
    variables:
      MOLECULE_SCENARIO_NAME: "ubuntu-18.04"

  "ubuntu-20.10":
    variables:
      MOLECULE_SCENARIO_NAME: "ubuntu-20.10"
    allow_failure: true

  "centos-8":
    variables:
      MOLECULE_SCENARIO_NAME: "centos-8"
    allow_failure: true

  "centos-7":
    variables:
      MOLECULE_SCENARIO_NAME: "centos-7"
    allow_failure: true

  "suse-15":
    variables:
      MOLECULE_SCENARIO_NAME: "suse-15"
    allow_failure: true

  "debian-10":
    variables:
      MOLECULE_SCENARIO_NAME: "debian-10"
    allow_failure: true

  "fedora-33":
    variables:
      MOLECULE_SCENARIO_NAME: "fedora-33"
    allow_failure: true
